If Not IsObject(application) Then
    Set SapGuiAuto = GetObject("SAPGUI")
    Set application = SapGuiAuto.GetScriptingEngine
End If
If Not IsObject(connection) Then
    Set connection = application.Children(0)
End If
If Not IsObject(session) Then
    Set session = connection.Children(0)
End If
If IsObject(WScript) Then
    WScript.ConnectObject session, "on"
    WScript.ConnectObject application, "on"
End If

' Maximiser la fenêtre
session.findById("wnd[0]").maximize
If session.children.count > 1 Then
    session.findById("wnd[1]/usr/radMULTI_LOGON_OPT2").select
    session.findById("wnd[1]/usr/radMULTI_LOGON_OPT2").setFocus
    session.findById("wnd[1]/tbar[0]/btn[0]").press
End If

' Préparer la date pour le nom de fichier
Dim xlapp, crnt_yr, crnt_day, crnt_mnth
crnt_yr = Year(Now)
If Day(Now) > 9 Then
    crnt_day = Day(Now)
Else
    crnt_day = "0" & Day(Now)
End If
If Month(Now) > 9 Then
    crnt_mnth = Month(Now)
Else
    crnt_mnth = "0" & Month(Now)
End If

' Extraire et exporter les données
On Error Resume Next
Set xlapp = GetObject(, "Excel.Application")
n = xlapp.Worksheets.Count
xlapp.Application.DisplayAlerts = False
xlapp.Worksheets(n).SaveAs("G:\Drive\..\Test_" & crnt_yr & "_" & crnt_mnth & "_" & crnt_day & ".xlsx")
While xlapp.Worksheets.Count <> n
    Wend
session.findById("wnd[1]/tbar[0]/btn[0]").press
On Error GoTo 0

' Fermer la transaction
session.findById("wnd[0]/tbar[0]/okcd").text = "/n"
session.findById("wnd[0]").sendVKey 0
Wscript.Sleep 2000
session.findById("wnd[0]").sendVKey 15


' Ajout du code pour gérer les messages d'erreur
Do
    ' Vérifier si un message d'erreur est affiché
    Dim errorMessage
    Set errorMessage = session.findById("wnd[0]/sbar")
    If errorMessage.MessageType = "E" Then
        ' Cliquer sur le bouton "OK" du message d'erreur
        session.findById("wnd[0]").sendVKey 0

        ' Envoyer un e-mail en cas d'erreur
        SendEmail "Erreur lors de l'extraction SAP", "Une erreur s'est produite lors de l'extraction SAP : " & errorMessage.Text
    End If

    ' Attendre avant de vérifier à nouveau les messages d'erreur
    WScript.Sleep 1000
Loop
