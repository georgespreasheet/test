' Script de surveillance (Monitor.vbs)
Dim objShell, objExec, sapClosed, inactivityCounter, timeout, checkInterval, sapLogonPath, retryAttempts, i, exitForInactivity
Dim session ' Ajoutez cette ligne pour définir une session SAP globale

Sub SAPConnect()
    ' ... (SAPConnect code)
End Sub

Sub RunSubVBS(SubPath)
    ' ... (RunSubVBS code)
End Sub

Sub ClickOKOnError(session) ' Ajoutez le paramètre session ici
    Dim errorMessage
    Set errorMessage = session.findById("wnd[0]/sbar")

    If errorMessage.MessageType = "E" Then
        ' Cliquer sur le bouton "OK" du message d'erreur
        session.findById("wnd[0]").sendVKey 0
    End If
End Sub

' ... (reste du code)

For i = 1 To retryAttempts
    exitForInactivity = False

    ' Ouvrir SAP si nécessaire
    If sapClosed Then
        objShell.Exec """" & sapLogonPath & """"
        WScript.Sleep 2000 ' Attendre que SAP s'ouvre (ajustez le temps d'attente si nécessaire)
        SAPConnect()
        sapClosed = False
    End If

    ' Exécuter le script principal
    On Error Resume Next
    Set objExec = objShell.Exec("wscript ne2.vbs")
    On Error GoTo 0

    ' Surveiller le script principal pour détecter les erreurs et vérifier l'inactivité
    inactivityCounter = 0
    Do
        If objExec.Status = 0 Then
            inactivityCounter = inactivityCounter + checkInterval
            If inactivityCounter >= timeout Then
                objShell.Run ("taskkill /F /IM saplogon.exe")
                Set objKillMainScript = objShell.Exec("taskkill /F /PID " & objExec.ProcessID)
                objShell.Run ("taskkill /F /IM EXCEL.exe") ' J'ai corrigé l'orthographe ici (EXCEL au lieu de EXEL)
                sapClosed = True
                exitForInactivity = True
                Exit Do
            End If
            WScript.Sleep checkInterval
        Else
            Exit Do
        End If
    Loop

    ' Si une erreur se produit ou si le script s'est terminé en raison de l'inactivité, relancer la tentative
    If objExec.ExitCode <> 0 Or exitForInactivity Then
        If i < retryAttempts Then
            sapClosed = True
        Else
            Exit For
        End If
    Else
        Exit For
    End If
Next

Set objExec = Nothing
Set objShell = Nothing
